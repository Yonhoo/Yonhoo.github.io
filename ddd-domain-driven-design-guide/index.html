<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>领域驱动设计 DDD 实践指南 | Yonhoo</title>
  <link rel="stylesheet" href="/css/fonts/Chinese-normal-normal.min.css">
  <link rel="stylesheet" href="/css/fonts/ChineseMono-normal-normal.min.css">
  <link rel="stylesheet" href="/css/fonts/Chinese-italic-normal.min.css">
  <link rel="stylesheet" href="/css/fonts/Chinese-normal-bold.min.css">


  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- SEO Meta Tags -->
  
  <meta name="description" itemprop="description" content="深入探讨领域驱动设计(DDD)的核心概念和实践方法，包括贫血模型vs充血模型、战略建模、战术建模、聚合设计等DDD核心思想，以及在微服务架构中的实际应用案例。">
  
  
  <!-- Keywords -->
  
  <meta name="keywords" content="DDD, 领域驱动设计, Domain Driven Design, 微服务, 聚合, 领域模型, 贫血模型, 充血模型, 战略建模, 战术建模, 限界上下文, 领域事件, 软件架构, 业务建模">
  
  
  <!-- Author -->
  <meta name="author" content="epic">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:type" content="article">
  <meta property="og:title" content="领域驱动设计 DDD 实践指南 | Yonhoo">
  <meta property="og:url" content="https://Yonhoo.github.io//ddd-domain-driven-design-guide/">
  <meta property="og:site_name" content="Yonhoo">
  
  <meta property="og:description" content="深入探讨领域驱动设计(DDD)的核心概念和实践方法，包括贫血模型vs充血模型、战略建模、战术建模、聚合设计等DDD核心思想，以及在微服务架构中的实际应用案例。">
  
  
  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="领域驱动设计 DDD 实践指南 | Yonhoo">
  
  <meta name="twitter:description" content="深入探讨领域驱动设计(DDD)的核心概念和实践方法，包括贫血模型vs充血模型、战略建模、战术建模、聚合设计等DDD核心思想，以及在微服务架构中的实际应用案例。">
  
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://Yonhoo.github.io//ddd-domain-driven-design-guide/">
  
  <!-- Language -->
  <meta http-equiv="content-language" content="en">
  
    <link rel="alternate" href="/atom.xml" title="Yonhoo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <!-- 额外的favicon格式支持 -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox-1.3.4.css">
  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <div id="nav-outer">
  <nav id="main-nav" class="outer">
    <a id="main-nav-toggle" class="nav-icon"></a>
    
      <a class="main-nav-link" href="/archives">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
    <div class="main-nav-space-between"></div>
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
    
  </nav>
</div>

<div id="header-title">
  <h1 id="logo-wrap">
    <a href="/" id="logo">Yonhoo</a>
  </h1>
  
    <h2 id="subtitle-wrap">
      <a href="/" id="subtitle">Tech Blog &amp; Personal Journey</a>
    </h2>
  
</div>

      <div id="content" class="outer">
        <section id="main"><article id="post-ddd-evolution" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/ddd-domain-driven-design-guide/" class="article-date">
  <time class="dt-published" datetime="2025-08-09T09:10:16.000Z" itemprop="datePublished">2025-08-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/">软件架构</a>►<a class="article-category-link" href="/categories/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      领域驱动设计 DDD 实践指南
    </h1>
  

      </header>
    
    
<!-- 鼠标悬停触发区域 -->
<div class="toc-hover-trigger"></div>

<!-- 左侧边栏TOC -->
<div id="sidebar-toc" class="sidebar-toc">
    <div class="toc-toggle" id="toc-toggle">
        <i class="fa fa-list"></i>
        <span>目录</span>
    </div>
    <div class="toc-content" id="toc-content">
        <div class="toc-header">
            <h3 class="toc-title">Table Of Contents</h3>
        </div>
        <div class="toc-body">
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.</span> <span class="toc-text">领域驱动设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.0.1.</span> <span class="toc-text">什么是领域驱动设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%AB%E8%A1%80%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.0.2.</span> <span class="toc-text">贫血模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%85%E8%A1%80%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.0.3.</span> <span class="toc-text">充血模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B%E9%A2%86%E5%9F%9F%E9%80%9A%E7%94%A8%E8%AF%AD%E8%A8%80"><span class="toc-number">1.0.4.</span> <span class="toc-text">建立领域通用语言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%88%98%E7%95%A5%E5%BB%BA%E6%A8%A1"><span class="toc-number">1.0.5.</span> <span class="toc-text">战略建模</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%90%E8%90%A5%E4%BA%BA%E5%91%98%F0%9F%A7%91%F0%9F%8F%BB%E2%80%8D%F0%9F%92%BB"><span class="toc-number">1.0.5.1.</span> <span class="toc-text">运营人员🧑🏻‍💻</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E2%9A%99%EF%B8%8F"><span class="toc-number">1.0.5.2.</span> <span class="toc-text">系统⚙️</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%9A%E5%A5%BD%E9%99%90%E7%95%8C%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">1.0.6.</span> <span class="toc-text">做好限界上下文</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#**%E6%88%98%E6%9C%AF%E5%BB%BA%E6%A8%A1**"><span class="toc-number">1.0.7.</span> <span class="toc-text">战术建模</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BD%93"><span class="toc-number">1.0.7.1.</span> <span class="toc-text">实体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%80%BC%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.0.7.2.</span> <span class="toc-text">值对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E6%A0%B9"><span class="toc-number">1.0.7.3.</span> <span class="toc-text">聚合根</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF"><span class="toc-number">1.0.8.</span> <span class="toc-text">核心业务场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E5%A4%8D%E6%9D%82%E6%80%A7%E6%8C%91%E6%88%98"><span class="toc-number">1.0.9.</span> <span class="toc-text">业务复杂性挑战</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%93%9A-%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5%EF%BC%9A%E4%BB%8E%E5%A4%A7%E6%B3%A5%E7%90%83%E5%88%B0%E5%9F%BA%E7%A1%80%E9%A2%86%E5%9F%9F%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.1.</span> <span class="toc-text">📚 第一阶段：从大泥球到基础领域模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF"><span class="toc-number">1.1.1.</span> <span class="toc-text">问题背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%B3%A5%E7%90%83%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B%EF%BC%88%E9%87%8D%E6%9E%84%E5%89%8D%EF%BC%89"><span class="toc-number">1.1.2.</span> <span class="toc-text">大泥球代码示例（重构前）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A7%E6%B3%A5%E7%90%83%E6%9E%B6%E6%9E%84%E7%9A%84%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">1.1.3.</span> <span class="toc-text">大泥球架构的问题分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E9%87%8D%E6%9E%84%EF%BC%9Ahoteloffer-v1"><span class="toc-number">1.1.4.</span> <span class="toc-text">初始重构：HotelOffer V1</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%F0%9F%8E%AF-%E9%87%8D%E6%9E%84%E6%94%B6%E7%9B%8A%E5%AF%B9%E6%AF%94"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">🎯 重构收益对比</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%94%84-%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5%EF%BC%9A%E9%98%B2%E8%85%90%E5%B1%82%E7%9A%84%E5%BB%BA%E7%AB%8B"><span class="toc-number">1.2.</span> <span class="toc-text">🔄 第二阶段：防腐层的建立</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E7%B3%BB%E7%BB%9F%E9%9B%86%E6%88%90%E6%8C%91%E6%88%98"><span class="toc-number">1.2.1.</span> <span class="toc-text">外部系统集成挑战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pricedata-%E6%BC%94%E8%BF%9B%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">PriceData 演进过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pricedata-v1: 基础版本"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">PriceData V1: 基础版本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pricedatav2:-增强版本 支持不同时段的定价"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">PriceDataV2: 增强版本 支持不同时段的定价</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E8%85%90%E5%B1%82%E8%AE%BE%E8%AE%A1%EF%BC%9Apricedataadapter"><span class="toc-number">1.2.3.</span> <span class="toc-text">防腐层设计：PriceDataAdapter</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%9A%80-%E7%AC%AC%E4%B8%89%E9%98%B6%E6%AE%B5%EF%BC%9A%E8%81%9A%E5%90%88%E6%A0%B9%E6%BC%94%E8%BF%9B"><span class="toc-number">1.3.</span> <span class="toc-text">🚀 第三阶段：聚合根演进</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hotelofferv2:-支持客户选择策略"><span class="toc-number">1.3.1.</span> <span class="toc-text">HotelOfferV2: 支持客户选择策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hybridoffer:-组合产品支持"><span class="toc-number">1.3.2.</span> <span class="toc-text">HybridOffer: 组合产品支持</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%F0%9F%8F%97%EF%B8%8F-%E7%AC%AC%E5%9B%9B%E9%98%B6%E6%AE%B5%EF%BC%9A%E5%A4%9A%E8%81%9A%E5%90%88%E5%8D%8F%E8%B0%83%E4%B8%8E%E9%A2%86%E5%9F%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.</span> <span class="toc-text">🏗️ 第四阶段：多聚合协调与领域服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%EF%BC%9A%E8%B7%A8%E8%81%9A%E5%90%88%E7%9A%84%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91"><span class="toc-number">1.4.1.</span> <span class="toc-text">问题：跨聚合的复杂业务逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%AE%9A%E4%BB%B7%E7%AD%96%E7%95%A5%E8%81%9A%E5%90%88%E6%A0%B9"><span class="toc-number">1.4.2.</span> <span class="toc-text">用户定价策略聚合根</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%90%A5%E9%94%80%E5%AE%9A%E4%BB%B7%E7%AD%96%E7%95%A5%E8%81%9A%E5%90%88%E6%A0%B9"><span class="toc-number">1.4.3.</span> <span class="toc-text">营销定价策略聚合根</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A2%86%E5%9F%9F%E6%9C%8D%E5%8A%A1%EF%BC%9Acomprehensivepricingdomainservice"><span class="toc-number">1.4.4.</span> <span class="toc-text">领域服务：ComprehensivePricingDomainService</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ddd-%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84"><span class="toc-number">1.5.</span> <span class="toc-text">DDD 分层架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1%E7%9A%84%E4%B8%8D%E5%81%9C%E6%BC%94%E8%BF%9B"><span class="toc-number">1.6.</span> <span class="toc-text">领域建模的不停演进</span></a></li></ol></li></ol>
        </div>
    </div>
</div>

<!-- TOC遮罩层 -->
<div id="toc-overlay" class="toc-overlay"></div>

<!-- TOC JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocToggle = document.getElementById('toc-toggle');
    const tocContent = document.getElementById('toc-content');
    const tocOverlay = document.getElementById('toc-overlay');
    const sidebarToc = document.getElementById('sidebar-toc');
    const tocLinks = tocContent.querySelectorAll('.toc-link');
    
    // 切换TOC显示状态
    function toggleToc() {
        sidebarToc.classList.toggle('active');
        tocOverlay.classList.toggle('active');
        document.body.classList.toggle('toc-open');
    }
    
    // 关闭TOC
    function closeToc() {
        sidebarToc.classList.remove('active');
        tocOverlay.classList.remove('active');
        document.body.classList.remove('toc-open');
    }
    
    // 事件监听
    tocToggle.addEventListener('click', toggleToc);
    tocOverlay.addEventListener('click', closeToc);
    
    // TOC链接点击后自动关闭（移动端）
    tocLinks.forEach(link => {
        link.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                setTimeout(closeToc, 300); // 延迟关闭，让滚动完成
            }
        });
    });
    
    // 键盘ESC关闭
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeToc();
        }
    });
    
    // 窗口大小变化时的处理
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            closeToc();
        }
    });
    
    // 滚动监听，高亮当前章节
    let headings = [];
    tocLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href && href.startsWith('#')) {
            const target = document.querySelector(href);
            if (target) {
                headings.push({
                    link: link,
                    target: target,
                    offset: target.offsetTop
                });
            }
        }
    });
    
    function updateActiveHeading() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        let activeHeading = null;
        
        // 找到当前可视区域内的标题
        for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            if (scrollTop >= heading.offset - 100) {
                activeHeading = heading;
                break;
            }
        }
        
        // 更新高亮状态
        tocLinks.forEach(link => link.classList.remove('active'));
        if (activeHeading) {
            activeHeading.link.classList.add('active');
            
            // 滚动TOC到当前项
            const tocBody = document.querySelector('.toc-body');
            if (tocBody && sidebarToc.classList.contains('active')) {
                const linkTop = activeHeading.link.offsetTop;
                const tocBodyHeight = tocBody.offsetHeight;
                const linkHeight = activeHeading.link.offsetHeight;
                
                if (linkTop < tocBody.scrollTop || linkTop > tocBody.scrollTop + tocBodyHeight - linkHeight) {
                    tocBody.scrollTop = linkTop - tocBodyHeight / 2;
                }
            }
        }
    }
    
    // 节流函数
    function throttle(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // 绑定滚动事件
    window.addEventListener('scroll', throttle(updateActiveHeading, 100));
    
    // 初始化高亮
    updateActiveHeading();
});
</script>

    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="领域驱动设计">领域驱动设计</h1>
<p><strong>领域驱动设计</strong>(Domain Driven Design)是一种软件设计方法，已经存在了近20年，在过去十年中，随着微服务和相关技术的激增，受到了巨大的关注。DDD更注重软件开发的逻辑、语义和结构方面(倾向于业务端)，而不是应用规范的实现方式，虽然它也提供了几种良好的设计模式。DDD是处理复杂软件的理想方法，但对于小型、独立项目来说可能会很冗长。</p>
<span id="more"></span>
<h3 id="什么是领域驱动设计">什么是领域驱动设计</h3>
<p>什么是领域？领域由三部分组成：</p>
<ol>
<li>领域里有用户，<strong>即涉众域</strong>；</li>
<li>用户要实现某种业务价值，解决某些痛点或实现某种诉求，<strong>即问题域</strong>；</li>
<li>面对业务价值，痛点和诉求，有对应的解决方案，这是<strong>解决方案域</strong>。</li>
</ol>
<p>什么是领域驱动设计？通俗地讲，针对特定业务，用户在面对业务问题时有对应的解决方案，这些问题与方案构成了领域知识，它包含流程、规则以及处理问题的方法，领域驱动设计就是围绕这些知识来设计系统。</p>
<p>以度假景点系统为例，度假景点系统所服务的用户有这几类：游客，运营，销售。解决 这几个核心问题：如何创建关联景点门票、酒店房型等商品组合，如何进行价格规则计算、什么时候进行售卖，订单如何扣减和支付。解决方案： 通过统一定义 product，里面涉及不同的景点门票和酒店房型的打包组合，同时定义不同的优惠方式，比如会员折扣，积分折扣等，构建时间售卖规则，构建订单流转流程，从订单、支付、扣减库存到发送邮件。</p>
<p><img src="Image.png" alt="DDD-mapping"></p>
<h3 id="贫血模型">贫血模型</h3>
<p>在领域模型中：只包含数据结构（字段、属性），没有任何业务逻辑的方法。叫做贫血模型。</p>
<h3 id="充血模型">充血模型</h3>
<p>在贫血模型中，数据和业务逻辑被分割到不同的类中。充血模型（Rich Domain Model）正好相反，数据和对应的业务逻辑被封装到同一个类中。因此，这种充血模型满足面向对象的封装特性，是典型的面向对象编程风格。</p>
<p><strong>为什么选择 DDD</strong></p>
<p>基于贫血模型的传统的开发模式，比较适合业务比较简单的系统开发。相对应的，基于充血模型的 DDD 开发模式，更适合业务复杂的系统开发。比如，包含各种利息计算模型、还款模型等复杂业务的金融系统。</p>
<p>领域模型相当于可复用的业务中间层。新功能需求的开发，都基于之前定义好的这些领域模型来完成。我们知道，越复杂的系统，对代码的复用性、易维护性要求就越高，我们就越应该花更多的时间和精力在前期设计上。而基于充血模型的 DDD 开发模式，正好需要我们前期做大量的业务调研、领域模型设计，所以它更加适合这种复杂系统的开发。</p>
<p>通过前期定义好领域知识，限定好上下文边界，从而可以形成高内聚，低耦合的业务单元，同时在同一个服务中，定义很好不同聚合的边界，使用领域模型，可以更好的在上层进行编排复用。</p>
<p>DDD 的核心诉求就是将业务架构映射到系统架构上，在响应业务变化调整业务架构时，也随之变化系统架构。</p>
<h3 id="建立领域通用语言">建立领域通用语言</h3>
<p>为了实践不同领域之间的交互关系，我们可以看一下现实生活中KFC小程序购买套餐的场景</p>
<p><img src="Image%20(2).png" alt="kfc-menu-1"></p>
<p><img src="Image%20(3).png" alt="kfc-menu-2"></p>
<h3 id="战略建模">战略建模</h3>
<p>User case</p>
<p>我将根据不同的角色出发，列出每个角色可能会涉及到的所有use case，然后罗列出每个use case可能会涵盖到的功能域，比如商品，订单，支付，库存等，从而识别出业务中的领域</p>
<p>User 🙎‍♂</p>
<p>选择商品加入购物车</p>
<p>用户可以浏览所有的商品，这里的商品可以是套餐，例如全家桶，小食拼盘等，也可以是单独种类的商品，香辣鸡翅🍗等</p>
<ul>
<li>修改购物车</li>
</ul>
<p>当用户选择了一些商品后，可以在购物车里进行修改，选择购买的数量，或者删除某些商品</p>
<ul>
<li>商品结算</li>
</ul>
<p>当用户添加好购物车后，选择外送或者堂食，然后进行结算</p>
<ul>
<li>下单支付</li>
<li>用户选择优惠助手中的商品添加进购物车</li>
</ul>
<p>用户可能领取了一些优惠套餐，然后就可以在规定时间内进行购买</p>
<ul>
<li>用户可以在优惠助手中选择满减优惠券，会员卡等进行折扣</li>
</ul>
<h4 id="运营人员🧑🏻‍💻">运营人员🧑🏻‍💻</h4>
<ul>
<li>配置商品</li>
</ul>
<p>运营人员可以配置一个可售卖的商品，比如商品的基本信息，商品可供选择的最小粒度产品，售卖数量范围，售卖时间，产品的折扣信息（打折，指定价格，买一赠一，会员折扣），赠品，售卖地区</p>
<ul>
<li>配置优惠助手</li>
</ul>
<p>将一些优惠套餐放进优惠助手中，限制使用次数，使用时间，来进行促销</p>
<ul>
<li>上架新产品</li>
<li>配置优惠券</li>
</ul>
<p>用户在商品结算时，可以通过使用优惠券(买一赠一，折扣)等来进行打折</p>
<ul>
<li>配置产品库存</li>
</ul>
<p>根据每天的供货量，配置每件产品的库存</p>
<h4 id="系统⚙️">系统⚙️</h4>
<ul>
<li>更新库存</li>
</ul>
<p>当用户每次购买商品中的产品后，需要进行库存的更新，防止系统库存超卖等现象，与此同时，当用户在下单某些商品时，因为库存不足，从而不能选择某些产品进行选购</p>
<ul>
<li>在优惠助手中展示用户可使用的卡券</li>
</ul>
<p>因为用户可能已经购买过有次数限制的优惠套餐，从而需要过滤掉用户已经使用过的卡券</p>
<ul>
<li>列举可售卖商品</li>
</ul>
<p>根据运营人员配置的商品售卖时间，来列举所有可售卖的商品，并且显示最小可购买价格</p>
<ul>
<li>计算商品结算时的价格</li>
</ul>
<p>上面所有use case，可以通过event storming的方式，将所有的场景列举出来</p>
<blockquote>
<p>领域驱动设计的一个核心的原则是使用一种基于模型的语言。因为模型是软件满足领域的共同点，它很适合作为这种通用语言的构造基础</p>
</blockquote>
<blockquote>
<p>使用模型作为语言的核心骨架。要求团队在进行所有的交流是都使用一致的语言，在代码中也是这样。在共享知识和推敲模型时，团队会使用演讲、文字和图形。这儿需要确保团队使用的语言在所有的交流形式中看上去都是一致的。因为这个原因，这种语言被称为<strong>通用语言(Ubiquitous Language)</strong></p>
</blockquote>
<blockquote>
<p>**在事件风暴过程中，通过团队交流达成共识的，能够简单、清晰、准确描述业务涵义和规则的语言就是通用语言。**也就是说，通用语言是团队统一的语言，不管你在团队中承担什么角色，在同一个领域的软件生命周期里都使用统一的语言进行交流。通用语言可以解决交流障碍这个问题，使领域专家和开发人员能够协同合作，从而确保业务需求的正确表达。</p>
</blockquote>
<p><img src="Image%20(4).png" alt="union language"></p>
<ul>
<li>Domain Event
<ul>
<li>用户选择套餐，选择优惠券和地址进行下单</li>
<li>某种产品库存已售罄</li>
<li>上架新产品</li>
</ul>
</li>
<li>Command
<ul>
<li>下单</li>
<li>更新库存</li>
<li>添加购物车</li>
<li>上架新产品</li>
</ul>
</li>
<li>Policy
<ul>
<li>选购某些套餐，其有固定购买数量</li>
<li>优惠券使用时间范围，每天最多使用次数</li>
</ul>
</li>
<li>Aggregates
<ul>
<li>产品</li>
<li>订单</li>
<li>优惠券</li>
</ul>
</li>
<li>Views
<ul>
<li>不同类别的产品</li>
<li>已有优惠券</li>
<li>购物车</li>
<li>已购订单</li>
</ul>
</li>
</ul>
<p><img src="spaces/KavC3w0wWUUBx4byjGaf/uploads/yCA57zIOgPyrANNdvlco/image.png" alt="image.png"></p>
<p>Core Domain： <strong>核心领域</strong>是一个组织赖以立足和区别于其他组织的根本所在。一个组织之所以能够成功，甚至能够存在，本质上依赖于其在核心领域中具备<strong>卓越的能力</strong>。正因为核心领域如此重要，它理应获得<strong>最高的优先级</strong>、<strong>最多的资源投入</strong>，以及<strong>最优秀的开发人员</strong>来实现。对于小型系统来说，可能只有一个核心领域；而在大型系统中，可能存在多个核心领域。</p>
<p>Support Domain： <strong>支撑子域</strong>是指那些虽然不是核心领域，但对于组织的成功依然不可或缺的业务领域。它不同于通用子域，因为它通常还需要结合组织的特定需求，进行一定程度的<strong>定制或专门化开发</strong>。在这种类型的子域中，组织<strong>可以在已有的通用解决方案基础上出发</strong>，通过<strong>调整、扩展或集成</strong>来满足自身业务的独特要求。</p>
<p>Generic Domain： <strong>通用子域</strong>是指那些在组织中没有独特性、但对整体系统运作仍然是<strong>必要组成部分</strong>的领域。这类子域的业务需求通常较为<strong>标准化</strong>，没有组织特有的复杂规则或流程。因此，组织可以通过采用<strong>现成的第三方解决方案</strong>（off-the-shelf software）来节省大量的开发时间和人力成本。一个典型的例子就是<strong>用户身份管理系统（如登录、注册、权限控制）</strong>，这类需求在不同组织之间大致相同，适合使用成熟的通用方案。</p>
<p>我们从整个小程序使用的生命周期开始先来识别所使用到的功能域：</p>
<ul>
<li><strong>商品配置</strong></li>
</ul>
<p>  一个商品在可以被售卖之前需要先在运营人员手里进行配置相关的售卖时间，不同种类的产品，可购买数量，产品的折扣信息，是否可以使用会员卡等；</p>
<ul>
<li><strong>优惠助手管理</strong></li>
</ul>
<p>  从小程序的界面上还可以看出，运营人员可以配置优惠助手中的优惠商品，来进行促销；</p>
<ul>
<li><strong>上架新商品</strong></li>
</ul>
<p>  运营人员可以通过<strong>上架新商品</strong>，来提供在不同时段可供售卖的商品</p>
<ul>
<li><strong>可售卖的商品和最小可购买价格</strong></li>
</ul>
<p>  在小程序上，最多的就是商品的展示了，那么在界面上需要显示<strong>可售卖的商品和最小可购买价格</strong></p>
<ul>
<li><strong>优惠券管理</strong></li>
</ul>
<p>  运营人员需要提供一些满减活动的优惠券，独立于商品，可以在订单进行结算时提供折扣，并且对于优惠券的使用次数和时间有一定的限制，并且需要在优惠助手进行展示的时候进行校验</p>
<ul>
<li><strong>优惠券使用</strong></li>
</ul>
<p>  当用户将购物车里的商品进行结算时，可以选择自己拥有哪些优惠券，来进行折扣，那么在订单进行价格计算时需要考虑进去</p>
<ul>
<li><strong>购物车管理</strong></li>
</ul>
<p>  用户可以随时修改购物车里的商品</p>
<ul>
<li><strong>订单结算</strong></li>
</ul>
<p>  当用户最终选择好购物车里的内容后，就可以跳转到商品结算页面，然后选择优惠券，进行最后的订单结算</p>
<ul>
<li><strong>订单详情</strong></li>
</ul>
<p>  当用户支付完成时，可以查看其购买的订单详情</p>
<ul>
<li><strong>支付</strong><br>
  用户可以选择用微信支付，或者银行卡来进行支付</li>
</ul>
<p>  当罗列了这些存在的功能后，我们其实可以进行领域的识别，从不同利益人的角度出发，可以划分出大部分不同的领域，比如从用户出发，就是最核心的围绕订单相关领域；</p>
<p>  从运营人员出发，就是商品配置，优惠助手管理，优惠券配置，而支付相关其实是依赖的第三方支付方式，可以作为支撑域来辅助订单领域；</p>
<p>  在小程序下，购物车的管理大部分是客户端来完成，目前暂时不考虑在服务中引入购物车相关概念。</p>
<p>  对于用户信息的展示，也需要相应的用户管理；</p>
<p>  对于最小粒度的产品，还需要管理其库存和价格，考虑到不同上下文可能存在的交互复杂度，这里假设我们使用的是第三方的产品管理平台来管控实时库存和价格。</p>
<h3 id="做好限界上下文">做好限界上下文</h3>
<p>在进行上下文划分之后，我们还需要进一步梳理上下文之间的关系。</p>
<blockquote>
<p>康威（梅尔·康威）定律</p>
<p>任何组织在设计一套系统（广义概念上的系统）时，所交付的设计方案在结构上都与该组织的沟通结构保持一致。</p>
</blockquote>
<p>康威定律告诉我们，系统结构应尽量的与组织结构保持一致。这里，我们认为团队结构（无论是内部组织还是团队间组织）就是组织结构，限界上下文就是系统的业务结构。因此，团队结构应该和限界上下文保持一致。</p>
<p>梳理清楚上下文之间的关系，从团队内部的关系来看，有如下好处：</p>
<ol>
<li>任务更好拆分，一个开发人员可以全身心的投入到相关的一个单独的上下文中；</li>
<li>沟通更加顺畅，一个上下文可以明确自己对其他上下文的依赖关系，从而使得团队内开发直接更好的对接。</li>
</ol>
<p>从团队间的关系来看，明确的上下文关系能够带来如下帮助：</p>
<ol>
<li>每个团队在它的上下文中能够更加明确自己领域内的概念，因为上下文是领域的解系统；</li>
<li>对于限界上下文之间发生交互，团队与上下文的一致性，能够保证我们明确对接的团队和依赖的上下游。</li>
</ol>
<p>在实际业务开发中，可以基于如下 3 个原则对限界上下文进行检验，并在适当时进行调整。</p>
<ul>
<li>原则 1：正交原则。包括业务能力正交、领域知识正交、领域模型正交。</li>
<li>原则 2：单一抽象层次原则（SLAP），即永远确保在同一层次上进行抽象。</li>
<li>原则 3：奥卡姆剃刀原则。如无必要，勿增实体。</li>
</ul>
<p><img src="Image%20(5).png" alt="Image.png"></p>
<p>限界上下文之间的映射关系</p>
<ul>
<li>合作关系（Partnership）：两个上下文紧密合作的关系，一荣俱荣，一损俱损。</li>
<li>共享内核（Shared Kernel）：两个上下文依赖部分共享的模型。</li>
<li>客户方-供应方开发（Customer-Supplier Development）：上下文之间有组织的上下游依赖。</li>
<li>遵奉者（Conformist）：下游上下文只能盲目依赖上游上下文。</li>
<li>防腐层（Anticorruption Layer）：一个上下文通过一些适配和转换与另一个上下文交互。</li>
<li>开放主机服务（Open Host Service）：定义一种协议来让其他上下文来对本上下文进行访问。</li>
<li>发布语言（Published Language）：通常与OHS一起使用，用于定义开放主机的协议。</li>
<li>大泥球（Big Ball of Mud）：混杂在一起的上下文关系，边界不清晰。</li>
<li>另谋他路（SeparateWay）：两个完全没有任何联系的上下文。</li>
</ul>
<h3 id="**战术建模**"><strong>战术建模</strong></h3>
<p>梳理清楚上下文之间的关系后，我们需要从战术层面上剖析上下文内部的组织关系。首先看下DDD中的一些定义。</p>
<h4 id="实体">实体</h4>
<p>  当一个对象由其标识（而不是属性）区分时，这种对象称为实体（Entity）。</p>
<p>例：最简单的，公安系统的身份信息录入，对于人的模拟，即认为是实体，因为每个人是独一无二的，且其具有唯一标识（如公安系统分发的身份证号码）。</p>
<h4 id="值对象">值对象</h4>
<p>  当一个对象用于对事务进行描述而没有唯一标识时，它被称作值对象（Value Object）。</p>
<p>例：比如颜色信息，我们只需要知道{&quot;name&quot;:&quot;黑色&quot;，&quot;css&quot;:&quot;#000000&quot;}这样的值信息就能够满足要求了，这避免了我们对标识追踪带来的系统复杂性。</p>
<h4 id="聚合根">聚合根</h4>
<p>  在 DDD 中，实体和值对象是很基础的领域对象。实体一般对应业务对象，它具有业务属性和业务行为；而值对象主要是属性集合，对实体的状态和特征进行描述。但实体和值对象都只是个体化的对象，它们的行为表现出来的是个体的能力。</p>
<p>  <strong>领域模型内的实体和值对象就好比个体，而能让实体和值对象协同工作的组织就是聚合，它用来确保这些领域对象在实现共同的业务逻辑时，能保证数据的一致性。</strong></p>
<p>  聚合就是由业务和逻辑紧密关联的实体和值对象组合而成的，聚合是数据修改和持久化的基本单元，每一个聚合对应一个仓储，实现数据的持久化。</p>
<p>  聚合在 DDD 分层架构里属于领域层，领域层包含了多个聚合，共同实现核心业务逻辑。聚合内实体以充血模型实现个体业务能力，以及业务逻辑的高内聚。跨多个实体的业务逻辑通过领域服务来实现，跨多个聚合的业务逻辑通过应用服务来实现。比如有的业务场景需要同一个聚合的 A 和 B 两个实体来共同完成，我们就可以将这段业务逻辑用领域服务来实现；而有的业务逻辑需要聚合 C 和聚合 D 中的两个服务共同完成，这时你就可以用应用服务来组合这两个服务。</p>
<p>  </p>
<p>在回到酒店预定系统，我们先看下核心业务场景：</p>
<h3 id="核心业务场景">核心业务场景</h3>
<p>酒店预订系统是一个典型的复杂业务领域，涉及多个业务概念和复杂的定价规则：</p>
<ol>
<li><strong>酒店产品管理</strong>: 房型、房间、入住规则</li>
<li><strong>价格管理</strong>: 基础价格、动态定价、优惠策略</li>
<li><strong>用户管理</strong>: 会员等级、地域差异、渠道偏好</li>
<li><strong>营销活动</strong>: 节假日定价、限时促销、季节性调整</li>
<li><strong>组合产品</strong>: 酒店+景点的混合产品</li>
</ol>
<h3 id="业务复杂性挑战">业务复杂性挑战</h3>
<ul>
<li><strong>动态定价</strong>: 价格根据日期、房型、供需关系实时变化</li>
<li><strong>多维度策略</strong>: 用户策略、营销策略、渠道策略的组合应用</li>
<li><strong>外部系统集成</strong>: 库存系统、支付系统、第三方价格数据</li>
<li><strong>业务规则复杂</strong>: 可用性检查、价格计算、用户权限验证</li>
<li><strong>演进需求</strong>: 业务需求不断变化，需要灵活的架构支持</li>
</ul>
<p>下面基于酒店领域系统进行上下文建模</p>
<p><img src="Image.jpeg" alt="Image.jpeg"></p>
<ol>
<li>聚合根：
<ul>
<li><strong>HotelOffer</strong>: 用来展示商品组合配置的生命周期</li>
<li><strong>UserPricingStrategy</strong>：用户定价策略聚合根，管理基于用户属性的定价</li>
<li><strong>MarketingPricingStrategy</strong>：营销定价策略聚合根，管理基于市场活动的定价</li>
</ul>
</li>
<li>实体
<ul>
<li><strong>HotelProduct</strong>: 酒店产品实体，包含房型和房间信息</li>
<li><strong>UserLevelDiscount</strong>: 用户等级折扣实体</li>
<li><strong>RegionPricing</strong>: 地域定价实体</li>
<li><strong>ChannelPricing</strong>: 渠道定价实体</li>
<li><strong>HolidayPricing</strong>：假日定价实体</li>
<li><strong>seasonalPricings</strong>: 季节定价实体</li>
<li><strong>FlashSaleActivities</strong>: 秒杀活动实体</li>
</ul>
</li>
<li>值对象
<ul>
<li><strong>UserContext</strong>: 用户上下文，包含用户等级、地域、渠道信息</li>
<li><strong>DateRange</strong>: 日期范围，表示有效期或入住期间</li>
<li><strong>PricePair</strong>: 价格对，包含基础价格和优惠价格</li>
<li><strong>UserLevel</strong>: 用户等级枚举（青铜、白银、黄金、白金、钻石）</li>
<li><strong>Region</strong>: 地域枚举（华北、华南、华东、华西、国际）</li>
<li><strong>Channel</strong>: 渠道枚举（官网、移动端、OTA、线下、企业）</li>
<li><strong>Inventory：</strong> 外部库存系统映射到商品活动上下文中的库存</li>
</ul>
</li>
<li>领域服务
<ol>
<li><strong>ComprehensivePricingDomainService ：</strong> 综合定价策略</li>
<li>**OfferAvailableService：**是否可售卖</li>
</ol>
</li>
<li>边界上下文
<ol>
<li><strong>酒店预订上下文</strong> (Hotel Booking Context)
<ul>
<li>核心业务逻辑</li>
<li>聚合根: HotelOffer, UserPricingStrategy, MarketingPricingStrategy</li>
</ul>
</li>
<li><strong>价格数据上下文</strong> (Price Data Context)
<ul>
<li>外部价格数据接入</li>
<li>防腐层: PriceDataAdapter</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>下面我将演示基于酒店领域系统在从大泥球架构到业务不断演进下的跨聚合的领域服务编排实现：</p>
<p><img src="Image%20(6).png" alt="架构迭代流程"></p>
<h2 id="📚-第一阶段：从大泥球到基础领域模型">📚 第一阶段：从大泥球到基础领域模型</h2>
<h3 id="问题背景">问题背景</h3>
<p>传统的大泥球架构通常表现为：</p>
<ul>
<li>所有业务逻辑混杂在一个巨大的类中</li>
<li>数据结构和业务行为耦合</li>
<li>外部系统依赖直接暴露在业务逻辑中</li>
<li>难以测试、维护和扩展</li>
</ul>
<h3 id="大泥球代码示例（重构前）">大泥球代码示例（重构前）</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 大泥球式的酒店价格查询服务 - 一切都混在一起</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">import</span> com.yonhoo.ddd.domain.model.HotelProduct;<br><span class="hljs-keyword">import</span> com.yonhoo.ddd.domain.model.PriceRule;<br><span class="hljs-keyword">import</span> com.yonhoo.ddd.domain.model.Validity;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationService</span> &#123;<br>    <span class="hljs-keyword">private</span> PriceRuleRepository priceRuleRepository;<br>    <span class="hljs-keyword">private</span> ProductRepository productRepository;<br>    <span class="hljs-keyword">private</span> ValidityRepository validityRepository;<br>    <span class="hljs-keyword">private</span> HotelOfferRepository hotelOfferRepository;<br>    <span class="hljs-keyword">private</span> PriceDataRepository priceDataRepository;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 应用层直接处理所有业务逻辑</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculateMinPriceV1</span><span class="hljs-params">(String offerNo, LocalDate checkInDay)</span> &#123;<br>        List&lt;PriceRule&gt; priceRule = priceRuleRepository.queryPriceRuleByOfferNo(offerNo);<br>        List&lt;HotelProduct&gt; hotelProducts = productRepository.queryHotelProductByOfferNo(offerNo);<br>        <span class="hljs-type">Validity</span> <span class="hljs-variable">validity</span> <span class="hljs-operator">=</span> validityRepository.queryValidityByOfferNo(offerNo);<br><br>        <span class="hljs-keyword">if</span> (calculateCheckInDayIsAvailable(validity, checkInDay)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;CheckInDay is not available&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> priceRule.stream().map(priceRuleItem -&gt; calculatePrice(priceRuleItem, hotelProducts, checkInDay))<br>                .filter(Objects::nonNull)<br>                .min(BigDecimal::compareTo)<br>                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;price is not available&quot;</span>));<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">calculateCheckInDayIsAvailable</span><span class="hljs-params">(Validity validity, LocalDate checkInDay)</span> &#123;<br>        <span class="hljs-comment">// logical processing</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <br>    &#125;<br><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculatePrice</span><span class="hljs-params">(PriceRule priceRule, List&lt;HotelProduct&gt; hotelProducts, LocalDate checkInDay)</span> &#123;<br>        <span class="hljs-comment">// logical processing</span><br>        <span class="hljs-keyword">return</span> BigDecimal.ONE; <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="大泥球架构的问题分析">大泥球架构的问题分析</h3>
<p><strong>1. 单一职责原则严重违背</strong>：</p>
<ul>
<li>一个类承担了查询库存、所有商品组合、价格规则，价格计算等多重职责</li>
</ul>
<p><strong>2. 业务逻辑和技术实现强耦合</strong>：</p>
<ul>
<li>业务规则硬编码在技术实现中</li>
<li>数据库操作和业务逻辑混杂</li>
</ul>
<p><strong>3. 外部系统依赖直接暴露</strong>：</p>
<ul>
<li>没有防腐层保护</li>
<li>外部系统变化直接影响业务逻辑</li>
</ul>
<p><strong>4. 业务规则难以变更</strong>：</p>
<ul>
<li>价格计算规则硬编码</li>
<li>添加新的折扣规则需要修改核心方法</li>
</ul>
<p><strong>5. 测试困难</strong>：</p>
<ul>
<li>方法过于庞大，依赖过多</li>
<li>难以进行单元测试</li>
</ul>
<p><strong>6. 可维护性差</strong>：</p>
<ul>
<li>代码结构混乱，理解困难</li>
<li>修改一个小功能可能影响整个系统</li>
</ul>
<h3 id="初始重构：hoteloffer-v1">初始重构：HotelOffer V1</h3>
<p>识别 hotelOffer 聚合根，将offer本身的能力下沉到领域层，对外直接提供最小价格查询功能，外部不需要感知最小价格内部的业务逻辑，只需要使用这个能力进行编排就行，不同开发人员只需要聚焦在自己领域的那块。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**  </span><br><span class="hljs-comment">* 酒店产品聚合根 - 第一版  </span><br><span class="hljs-comment">* 从大泥球中提取出的核心业务概念  </span><br><span class="hljs-comment">*/</span>  <br><span class="hljs-keyword">import</span> com.yonhoo.ddd.domain.model.*;<br><br><span class="hljs-keyword">import</span> java.math.BigDecimal;<br><span class="hljs-keyword">import</span> java.time.LocalDate;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotelOffer</span> &#123;<br>    String offerNo;<br>    HotelProduct products;<br>    List&lt;PriceRule&gt; priceRuleList;<br>    Validity validity;<br>    List&lt;Channel&gt; channels;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 验证指定日期是否可以入住（聚合内业务规则）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAvailableForCheckIn</span><span class="hljs-params">(LocalDate checkInDay)</span> &#123;<br>        <span class="hljs-keyword">return</span> validity.validateCheckInDayIsAvailable(checkInDay);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculateMinPrice</span><span class="hljs-params">(LocalDate checkInDay, Map&lt;String, ? extends AbstractPriceData&gt; roomPriceData)</span> &#123;<br>        <span class="hljs-comment">// 内部业务逻辑完全封装，外部无需知道PriceRule、HotelProduct等细节</span><br>        <span class="hljs-keyword">return</span> priceRuleList.stream().map(priceRule -&gt; &#123;<br>                    <span class="hljs-type">DateRange</span> <span class="hljs-variable">occupationDateRange</span> <span class="hljs-operator">=</span> products.minOccupationDateRange(checkInDay);<br>                    <span class="hljs-keyword">return</span> occupationDateRange.toStream()<br>                            .map(calculatedDay -&gt; products.getHotelProducts().stream().map(room -&gt;<br>                                            priceRule.getPrice(calculatedDay, roomPriceData.get(room.getRoomNo()).getMinPriceByDay(calculatedDay)))<br>                                    .min(BigDecimal::compareTo)<br>                                    .orElse(BigDecimal.ZERO))<br>                            .reduce(BigDecimal::add)<br>                            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;price is not available&quot;</span>));<br>                &#125;)<br>                .min(BigDecimal::compareTo)<br>                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;price is not available&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>⚠️注：</p>
<p>这里之前在设计的时候，一直存在一个问题，为什么外部的价格系统：外部库存和价格不属于 HotelOffer 聚合，应该通过领域服务协作，不应该注入 HotelOffer 中，这样会破坏聚合。为什么这里还通过参数传进去呢？</p>
<p>聚合根可以在行为中<strong>接受来自其他上下文的只读数据作为参数</strong>，用于做出业务决策，只要：</p>
<ul>
<li>它不会将这些数据变成自身持久化状态；</li>
<li>它不会因此破坏自身聚合边界；</li>
<li>它仍然主导业务规则的决策。</li>
<li>外部的信息需要做好防腐层的映射，只提供 HotelOffer 需要的能力，这样 HotelOffer 就不需要感知到外部信息的变化，只聚焦自己本身的业务</li>
</ul>
<p>应用层只需要查出这个HotelOffer的聚合，然后聚合基于实时价格查出当前最小价格：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationServcie</span> &#123;<br><br>    <span class="hljs-keyword">private</span> HotelOfferRepository hotelOfferRepository;<br>    <span class="hljs-keyword">private</span> PriceDataRepository priceDataRepository;<br><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculateMinPriceV2</span><span class="hljs-params">(String offerNo, LocalDate checkInDay)</span> &#123;<br>        <span class="hljs-comment">// 1. 获取聚合根</span><br>        <span class="hljs-type">HotelOffer</span> <span class="hljs-variable">hotelOffer</span> <span class="hljs-operator">=</span> hotelOfferRepository.queryHotelOfferByOfferNo(offerNo);<br><br>        <span class="hljs-comment">// 2. 获取外部价格数据</span><br>        List&lt;String&gt; roomNoList = hotelOffer.getRoomNoList();<br>        Map&lt;String, PriceData&gt; roomPriceDataMap = priceDataRepository.queryPriceDataByRoomList(roomNoList);<br><br>        <span class="hljs-comment">// 3. 使用领域服务协调聚合和外部数据</span><br>        <span class="hljs-keyword">return</span> hotelOffer.calculateMinPrice(checkInDay, roomPriceDataMap);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>关键改进</strong>：</p>
<ol>
<li><strong>业务概念清晰化</strong>: 明确了HotelOffer作为酒店产品的核心概念</li>
<li><strong>封装业务规则</strong>: 将价格计算逻辑封装在聚合根内部</li>
<li><strong>依赖倒置</strong>: 通过AbstractPriceData抽象外部价格数据</li>
</ol>
<h4 id="🎯-重构收益对比">🎯 重构收益对比</h4>
<table>
<thead>
<tr>
<th><strong>维度</strong></th>
<th><strong>重构前（大泥球）</strong></th>
<th><strong>重构后（DDD）</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>代码行数</strong></td>
<td>单个方法</td>
<td>多个职责清晰的小方法</td>
</tr>
<tr>
<td><strong>业务概念</strong></td>
<td>混杂不清</td>
<td>聚合根、实体、值对象清晰</td>
</tr>
<tr>
<td><strong>测试性</strong></td>
<td>难以单元测试</td>
<td>每个组件可独立测试</td>
</tr>
<tr>
<td><strong>扩展性</strong></td>
<td>修改影响全局</td>
<td>职责分离，影响局部</td>
</tr>
<tr>
<td><strong>可读性</strong></td>
<td>需要深入理解所有细节</td>
<td>业务概念一目了然</td>
</tr>
<tr>
<td><strong>维护性</strong></td>
<td>高风险，牵一发动全身</td>
<td>低风险，职责边界清晰</td>
</tr>
</tbody>
</table>
<h2 id="🔄-第二阶段：防腐层的建立">🔄 第二阶段：防腐层的建立</h2>
<h3 id="外部系统集成挑战">外部系统集成挑战</h3>
<p>随着业务发展，需要集成多个外部系统：</p>
<ul>
<li>价格数据系统（版本不断演进）</li>
<li>库存管理系统</li>
<li>第三方OTA平台</li>
</ul>
<h3 id="pricedata-演进过程">PriceData 演进过程</h3>
<h4 id="pricedata-v1: 基础版本">PriceData V1: 基础版本</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriceData</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPriceData</span> &#123;<br>    <span class="hljs-keyword">private</span> String roomNo;<br><br>    <span class="hljs-keyword">private</span> List&lt;PricePair&gt; pricePairs;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getMinPriceByDay</span><span class="hljs-params">(LocalDate day)</span> &#123;<br>        <span class="hljs-keyword">return</span> pricePairs.stream().filter(item -&gt; day.isEqual(item.getDay()))<br>                .map(PricePair::getPrice)<br>                .min(BigDecimal::compareTo)<br>                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;no available price&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-meta">@Data</span><br>    <span class="hljs-meta">@AllArgsConstructor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PricePair</span> &#123;<br>        <span class="hljs-keyword">private</span> LocalDate day;<br>        <span class="hljs-keyword">private</span> BigDecimal price;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="pricedatav2:-增强版本 支持不同时段的定价">PriceDataV2: 增强版本 支持不同时段的定价</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriceDataV2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPriceData</span> &#123;<br>    <span class="hljs-keyword">private</span> String roomNo;<br>    <span class="hljs-keyword">private</span> List&lt;TimingPrice&gt; timingPriceList; <span class="hljs-comment">// 支持时间维度的价格  </span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getMinPriceByDay</span><span class="hljs-params">(LocalDate day)</span> &#123;<br><span class="hljs-comment">// 支持多时段价格，选择最优价格  </span><br>        <span class="hljs-keyword">return</span> timingPriceList.stream()<br>                .filter(timingPrice -&gt; timingPrice.getDay().isEqual(day))<br>                .map(TimingPrice::getPrice)<br>                .min(BigDecimal::compareTo)<br>                .orElseThrow();<br>    &#125;<br><br>    <span class="hljs-comment">// 内部类：支持时间维度的价格  </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimingPrice</span> &#123;<br>        <span class="hljs-keyword">private</span> BigDecimal price;<br>        <span class="hljs-keyword">private</span> LocalTime timing;<br>        <span class="hljs-keyword">private</span> LocalDate day;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="防腐层设计：pricedataadapter">防腐层设计：PriceDataAdapter</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 价格数据适配器 - 增强防腐层</span><br><span class="hljs-comment"> * 将外部价格数据转换为聚合根友好的领域概念</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PriceDataAdapter</span> &#123;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 将外部价格数据适配为聚合根内部使用的价格查询器</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RoomPriceQuery <span class="hljs-title function_">adaptToPriceQuery</span><span class="hljs-params">(Map&lt;String, ? extends AbstractPriceData&gt; externalPriceData)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RoomPriceQuery</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">queryRoomMinPrice</span><span class="hljs-params">(String roomNo, LocalDate day)</span> &#123;<br>                <span class="hljs-type">AbstractPriceData</span> <span class="hljs-variable">priceData</span> <span class="hljs-operator">=</span> externalPriceData.get(roomNo);<br>                <span class="hljs-keyword">if</span> (priceData == <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;No price data found for room: &quot;</span> + roomNo);<br>                &#125;<br>                <span class="hljs-keyword">return</span> priceData.getMinPriceByDay(day);<br>            &#125;<br>            <br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasDataForRoom</span><span class="hljs-params">(String roomNo)</span> &#123;<br>                <span class="hljs-keyword">return</span> externalPriceData.containsKey(roomNo);<br>            &#125;<br>        &#125;;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 聚合根内部使用的价格查询接口 - 领域概念</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RoomPriceQuery</span> &#123;<br>        BigDecimal <span class="hljs-title function_">queryRoomMinPrice</span><span class="hljs-params">(String roomNo, LocalDate day)</span>;<br>        <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasDataForRoom</span><span class="hljs-params">(String roomNo)</span>;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 使用适配器的计算方法 - 更纯粹的领域概念</span><br><span class="hljs-comment">     * 展示如何进一步增强防腐层</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculateMinPriceWithAdapter</span><span class="hljs-params">(LocalDate checkInDay, </span><br><span class="hljs-params">                                                   PriceDataAdapter.RoomPriceQuery priceQuery)</span> &#123;<br>        <span class="hljs-comment">// 使用领域友好的价格查询接口，而不是直接依赖外部数据结构</span><br>        <span class="hljs-keyword">return</span> priceRuleList.stream().map(priceRule -&gt; &#123;<br>                    <span class="hljs-type">DateRange</span> <span class="hljs-variable">occupationDateRange</span> <span class="hljs-operator">=</span> products.minOccupationDateRange(checkInDay);<br>                    <span class="hljs-keyword">return</span> occupationDateRange.toStream()<br>                            .map(calculatedDay -&gt; products.getHotelProducts().stream()<br>                                    .filter(room -&gt; priceQuery.hasDataForRoom(room.getRoomNo()))<br>                                    .map(room -&gt; priceRule.getPrice(calculatedDay, <br>                                                    priceQuery.queryRoomMinPrice(room.getRoomNo(), calculatedDay)))<br>                                    .min(BigDecimal::compareTo)<br>                                    .orElse(BigDecimal.ZERO))<br>                            .reduce(BigDecimal::add)<br>                            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;price is not available&quot;</span>));<br>                &#125;)<br>                .min(BigDecimal::compareTo)<br>                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;price is not available&quot;</span>));<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>通过PriceDataAdapter 可以完全屏蔽来自聚合外的知识，在这个聚合计算最小价格时，不需要感知外部业务的价格变化，只需要通过 roomNo 的引用，就可以完成价格的查询，配置聚合内的商品进行价格计算。</p>
<p><strong>防腐层的价值</strong>：</p>
<ol>
<li><strong>隔离变化</strong>: 外部系统变化不影响核心业务逻辑</li>
<li><strong>领域友好</strong>: 提供符合业务语言的接口</li>
<li><strong>版本兼容</strong>: 支持多版本外部系统同时存在</li>
</ol>
<h2 id="🚀-第三阶段：聚合根演进">🚀 第三阶段：聚合根演进</h2>
<h3 id="hotelofferv2:-支持客户选择策略">HotelOfferV2: 支持客户选择策略</h3>
<p>业务需求变化：需要支持不同的客户选择策略（固定价格、最低价格等）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**  </span><br><span class="hljs-comment">* 酒店产品聚合根V2  </span><br><span class="hljs-comment">* 新增：客户选择策略支持  </span><br><span class="hljs-comment">*/</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotelOfferV2</span> &#123;<br>    String offerNo;<br>    HotelProduct products;<br>    CustomerChoice customerChoice;<br>    List&lt;PriceRule&gt; priceRuleList;<br>    Validity validity;<br>    <br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算最低价格（核心业务方法）</span><br><span class="hljs-comment">     * 支持客户选择策略，内部逻辑完全封装</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculateMinPrice</span><span class="hljs-params">(LocalDate checkInDay, PriceDataAdapter.RoomPriceQuery priceQuery)</span> &#123;<br>        <span class="hljs-keyword">return</span> priceRuleList.stream().map(priceRule -&gt; &#123;<br>                    <span class="hljs-type">DateRange</span> <span class="hljs-variable">occupationDateRange</span> <span class="hljs-operator">=</span> products.minOccupationDateRange(checkInDay);<br>                    <span class="hljs-keyword">return</span> occupationDateRange.toStream()<br>                            .map(calculatedDay -&gt; products.getHotelProducts().stream().map(room -&gt;<br>                                            priceRule.getPrice(calculatedDay, priceQuery.queryRoomMinPrice(room.getRoomNo(), calculatedDay)))<br>                                    .reduce(getMinimalPriceCalculateMethod(customerChoice))<br>                                    .orElse(BigDecimal.ZERO))<br>                            .reduce(BigDecimal::add)<br>                            .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;price is not available&quot;</span>));<br>                &#125;)<br>                .min(BigDecimal::compareTo)<br>                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;price is not available&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据客户选择确定价格计算方法（内部策略）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> BinaryOperator&lt;BigDecimal&gt; <span class="hljs-title function_">getMinimalPriceCalculateMethod</span><span class="hljs-params">(CustomerChoice customerChoice)</span> &#123;<br>        <span class="hljs-keyword">if</span> (customerChoice == CustomerChoice.FIXED) &#123;<br>            <span class="hljs-keyword">return</span> BigDecimal::add;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> BigDecimal::min;<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>演进亮点</strong>：</p>
<ol>
<li><strong>策略模式</strong>: 通过CustomerChoice支持不同的价格计算策略</li>
<li><strong>向后兼容</strong>: 保持原有接口不变，添加新功能</li>
<li><strong>业务规则封装</strong>: 策略选择逻辑完全封装在聚合根内部, 外部业务层无需感知，也不需要变动</li>
</ol>
<h3 id="hybridoffer:-组合产品支持">HybridOffer: 组合产品支持</h3>
<p>业务进一步演进：需要支持酒店+景点的组合产品</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 混合产品聚合根</span><br><span class="hljs-comment"> * 支持酒店+景点的组合产品</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HybridOffer</span> &#123;<br>    <span class="hljs-keyword">private</span> ProductGroups productGroups; <span class="hljs-comment">// 产品组合  </span><br>    <span class="hljs-keyword">private</span> String offerNo;<br>    <span class="hljs-keyword">private</span> List&lt;PriceRule&gt; priceRuleList;<br>    <span class="hljs-keyword">private</span> Validity validity;<br>    <span class="hljs-keyword">private</span> CustomerChoice customerChoice;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 组合产品价格计算</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getMinPriceV3</span><span class="hljs-params">(LocalDate checkInDay,</span><br><span class="hljs-params">                                    Map&lt;String, ? extends AbstractPriceData&gt; priceData)</span> &#123;<br>        <span class="hljs-comment">// 验证可用性  </span><br>        <span class="hljs-keyword">if</span> (!validity.validateCheckInDayIsAvailable(checkInDay)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;checkInDay is not available&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 计算酒店部分价格  </span><br>        <span class="hljs-type">HotelProduct</span> <span class="hljs-variable">hotelProduct</span> <span class="hljs-operator">=</span> productGroups.getHotelProduct();<br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">hotelPrice</span> <span class="hljs-operator">=</span> calculateHotelPrice(checkInDay, priceData, hotelProduct);<br><br>        <span class="hljs-comment">// 计算景点部分价格  </span><br>        <span class="hljs-type">AttractionProduct</span> <span class="hljs-variable">attractionProduct</span> <span class="hljs-operator">=</span> productGroups.getAttractionProduct();<br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">attractionPrice</span> <span class="hljs-operator">=</span> calculateAttractionPrice(checkInDay, priceData, attractionProduct);<br><br>        <span class="hljs-comment">// 组合价格  </span><br>        <span class="hljs-keyword">return</span> hotelPrice.add(attractionPrice);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取不同产品类型的标识符列表</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getHotelRoomList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> productGroups.getHotelProduct().getHotelProducts().stream()<br>                .map(RoomInfo::getRoomNo)<br>                .collect(Collectors.toList());<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getAttractionTicketList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> productGroups.getAttractionProduct().getProductItemList().stream()<br>                .map(TicketItem::getProductNumber)<br>                .collect(Collectors.toList());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><strong>关键创新</strong>：</p>
<ol>
<li><strong>组合模式</strong>: 通过ProductGroups管理不同类型的产品</li>
<li><strong>统一接口</strong>: 对外提供一致的价格计算接口</li>
<li><strong>扩展性</strong>: 易于添加新的产品类型,商品组合只在聚合内进行变化，对外还是提供价格计算</li>
</ol>
<h2 id="🏗️-第四阶段：多聚合协调与领域服务">🏗️ 第四阶段：多聚合协调与领域服务</h2>
<h3 id="问题：跨聚合的复杂业务逻辑">问题：跨聚合的复杂业务逻辑</h3>
<p>随着业务复杂度增加，出现了跨多个聚合的复杂业务场景：</p>
<ul>
<li>用户定价策略（基于用户属性，会员策略，渠道）</li>
<li>营销定价策略（基于市场活动，促销、假日限购）</li>
<li>综合定价逻辑（协调多个策略）</li>
</ul>
<h3 id="用户定价策略聚合根">用户定价策略聚合根</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 用户定价策略聚合根</span><br><span class="hljs-comment"> * 职责：管理基于用户属性的定价策略（等级、地域、渠道等）</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPricingStrategy</span> &#123;<br>    <span class="hljs-keyword">private</span> String strategyId;<br>    <span class="hljs-keyword">private</span> String strategyName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> active;<br>    <span class="hljs-keyword">private</span> PriorityLevel strategyPriority;<br><br>    <span class="hljs-comment">// 时效性支持  </span><br>    <span class="hljs-keyword">private</span> LocalDateTime effectiveStartTime;<br>    <span class="hljs-keyword">private</span> LocalDateTime effectiveEndTime;<br>    <span class="hljs-keyword">private</span> DateRange validDateRange;<br><br>    <span class="hljs-comment">// 策略组件  </span><br>    <span class="hljs-keyword">private</span> List&lt;UserLevelDiscount&gt; userLevelDiscounts;<br>    <span class="hljs-keyword">private</span> List&lt;RegionPricing&gt; regionPricings;<br>    <span class="hljs-keyword">private</span> List&lt;ChannelPricing&gt; channelPricings;<br>    <span class="hljs-keyword">private</span> PriorityRule priorityRule;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 核心业务方法：计算用户策略折扣</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculateUserDiscount</span><span class="hljs-params">(BigDecimal basePrice,</span><br><span class="hljs-params">                                            UserContext userContext,</span><br><span class="hljs-params">                                            LocalDateTime currentTime)</span> &#123;<br>        <span class="hljs-comment">//processing....</span><br><br>        <span class="hljs-keyword">return</span> finalPrice;<br>    &#125;<br><br><br>&#125;<br>  <br></code></pre></td></tr></table></figure>
<h3 id="营销定价策略聚合根">营销定价策略聚合根</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 营销定价策略聚合根  </span><br><span class="hljs-comment"> * 职责：管理节假日、限时活动等可配置的营销策略  </span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MarketingPricingStrategy</span> &#123;<br>    <span class="hljs-keyword">private</span> String strategyId;<br>    <span class="hljs-keyword">private</span> String strategyName;<br>    <span class="hljs-keyword">private</span> StrategyType strategyType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> active;<br>    <span class="hljs-keyword">private</span> DateRange effectivePeriod;<br>    <span class="hljs-keyword">private</span> PriorityLevel priorityLevel;<br><br>    <span class="hljs-comment">// 不同类型的营销策略  </span><br>    <span class="hljs-keyword">private</span> List&lt;HolidayPricing&gt; holidayPricings;<br>    <span class="hljs-keyword">private</span> List&lt;FlashSaleActivity&gt; flashSaleActivities;<br>    <span class="hljs-keyword">private</span> List&lt;SeasonalPricing&gt; seasonalPricings;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算营销策略价格  </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">calculateMarketingPrice</span><span class="hljs-params">(BigDecimal basePrice,</span><br><span class="hljs-params">                                              LocalDate targetDate,</span><br><span class="hljs-params">                                              MarketingContext context)</span> &#123;<br>        <span class="hljs-comment">//processing....</span><br><br>        <span class="hljs-keyword">return</span> finalPrice;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="领域服务：comprehensivepricingdomainservice">领域服务：ComprehensivePricingDomainService</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**  </span><br><span class="hljs-comment">* 综合定价领域服务  </span><br><span class="hljs-comment">* 职责：协调 HotelOffer 基础价格、用户策略定价、营销策略定价，计算最终价格  </span><br><span class="hljs-comment">*/</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComprehensivePricingDomainService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 计算综合最终价格</span><br><span class="hljs-comment">     * 体现了领域服务协调多个聚合根的职责</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PricingResult <span class="hljs-title function_">calculateFinalPrice</span><span class="hljs-params">(</span><br><span class="hljs-params">            HotelOffer hotelOffer,</span><br><span class="hljs-params">            LocalDate checkInDay,</span><br><span class="hljs-params">            Map&lt;String, ? extends AbstractPriceData&gt; roomPriceData,</span><br><span class="hljs-params">            UserContext userContext,</span><br><span class="hljs-params">            MarketingContext marketingContext,</span><br><span class="hljs-params">            List&lt;UserPricingStrategy&gt; userPricingStrategies,</span><br><span class="hljs-params">            List&lt;MarketingPricingStrategy&gt; marketingPricingStrategies)</span> &#123;<br><br>        <span class="hljs-comment">// 1. 计算基础价格 (HotelOffer聚合根)</span><br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">basePrice</span> <span class="hljs-operator">=</span> HotelPricingDomainService.calculateMinPrice(<br>                hotelOffer, checkInDay, roomPriceData);<br><br>        <span class="hljs-comment">// 2. 应用用户策略定价 (UserPricingStrategy聚合根)</span><br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">userDiscountedPrice</span> <span class="hljs-operator">=</span> applyUserPricingStrategies(<br>                basePrice, userContext, userPricingStrategies);<br><br>        <span class="hljs-comment">// 3. 应用营销策略定价 (MarketingPricingStrategy聚合根)</span><br>        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">marketingPrice</span> <span class="hljs-operator">=</span> applyMarketingPricingStrategies(<br>                userDiscountedPrice, checkInDay, marketingContext, marketingPricingStrategies);<br><br>        <span class="hljs-comment">// 4. 构建定价结果</span><br>        <span class="hljs-keyword">return</span> buildPricingResult(basePrice, userDiscountedPrice, marketingPrice,<br>                checkInDay, userContext, marketingContext);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>通过这次的业务迭代和不断地聚合演进，可以看出，随着业务迭代，我们始终聚焦在各个上下文内部，当业务迭代后，只需要在聚合内部进行业务变更，外层不需要感知，应用层还是保持不变，同时当存在多个聚合时，可以通过领域服务来进行跨聚合的处理，对于应用层还是无感知的。</p>
<p><img src="aggregation-ddd.png" alt="DDD-Aggregation"></p>
<h2 id="ddd-分层架构">DDD 分层架构</h2>
<p>在进行分层时，我们保证同一层的组件处于同一个抽象层次。这是分层架构的设计原则，通过“单一抽象层次原则（SLAP）”，可以保证每层的上下文边界都限制在该层中，通过上下文的映射来进行信息传递，避免不同层的变化，导致业务进行变动。</p>
<p><img src="ddd-layer.jpg" alt="DDD 分层"></p>
<h2 id="领域建模的不停演进">领域建模的不停演进</h2>
<p>在业务流程设计过程中，随着业务的迭代，业务提供的能力也会不断增加，在前期设计过程中，可能无法预测应用层到底会具备什么能力，我们可以在领域层提供不同聚合的能力，变成原子能力，如图中所示例，刚开始应用层服务A、B，只需要领域服务 a、领域服务 b，随着业务迭代，需要提供一种新的业务能力，由于底层的领域层我们已经封装了原子的能力，那么提供一个新的领域服务，来编排不同的聚合能力，来达到新业务的需求。通过这种方式，可以灵活的适应业务的迭代，以及编排的复杂度。</p>
<p><img src="ddd-iterator.jpg" alt="业务持续迭代"></p>

      
    </div>
    <footer class="article-footer">
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DDD/" rel="tag">DDD</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%9A%E5%8A%A1%E5%BB%BA%E6%A8%A1/" rel="tag">业务建模</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag">微服务</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/" rel="tag">软件架构</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/" rel="tag">领域驱动设计</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/monstache-elasticsearch-sync-tutorial/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          monstache 同步 es 学习
        
      </div>
    </a>
  
</nav>

  
</article>


</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 epic<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a><br>
      
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/archives" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="/js/clipboard.min.js"></script>
<script src="/js/jquery-1.4.3.min.js"></script>

<script src="/fancybox/jquery.fancybox-1.3.4.pack.js"></script>


<script src="/js/script.js"></script>






<script>
  MathJax = {
    options: {
      enableMenu: false
    },
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
    }
  };
</script>
<!-- <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
    CommonHTML: {
      linebreaks: false
    }
  });
  </script> -->
<script type="text/javascript" id="MathJax-script" async
  src="/mathjax/tex-chtml.js">
</script>
<!-- <script type="text/javascript"
   src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS_CHTML">
</script> -->

  </div>
  
  <!-- 回到顶部按钮 -->
  <button id="back-to-top" title="回到顶部" aria-label="回到顶部">
    <i class="fa fa-chevron-up" aria-hidden="true"></i>
  </button>
</body>
</html>